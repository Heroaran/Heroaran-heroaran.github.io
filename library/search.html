<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>몬스터 및 아이템 검색</title>
</head>
<body>
  <div class="container">
    <h1>몬스터 및 아이템 검색</h1>
    <input type="text" id="monsterSearchInput" placeholder="몬스터 이름으로 검색">
    <button onclick="searchMonsters()">검색</button>
    <input type="text" id="itemSearchInput" placeholder="아이템 이름으로 검색">
    <button onclick="searchItems()">검색</button>
    <div id="results"></div>
  </div>

<script>
const monsterImagePath = "images/monsters/";
const itemImagePath = "images/items/";

let monsterData = [];
let bossData = [];

function sanitizeMonsterName(name) {
  return name;
}

function sanitizeItemName(name) {
  const scrollMatch = name.match(/scroll[^\d]*(\d+)%/i);
  if (scrollMatch) {
    return "Scroll" + scrollMatch[1];
  }
  name = name.replace(/\s*\((M|F)\)\s*$/i, '');
  return name.replace(/[^a-zA-Z0-9]/g, '_');
}

function getImageElement(path, displayName, isItem = false, realFilename = null) {
  const img = document.createElement('img');
  img.alt = displayName;
  const filename = realFilename || displayName;

  img.src = path + filename + '.png';
  img.onerror = function () {
    img.onerror = null;
    img.src = path + filename + '.gif';
  };

  return img;
}

async function loadData() {
  try {
    const [monsterResp, bossResp] = await Promise.all([
      fetch('data/monster/monster_data.json'),
      fetch('data/monster/boss_data.json')
    ]);
    monsterData = await monsterResp.json();
    bossData = await bossResp.json();
  } catch (e) {
    document.getElementById('results').innerText = "데이터 로드 실패: " + e;
  }
}

function searchMonsters() {
  const input = document.getElementById("monsterSearchInput").value.trim().toLowerCase();
  const terms = input.split(',').map(t => t.trim()).filter(t => t);
  const results = [];

  [...monsterData, ...bossData].forEach(mon => {
    if (terms.some(term => mon.name.toLowerCase().includes(term))) {
      results.push(mon);
    }
  });

  renderMonsterResults(results);
}

function searchItems() {
  const input = document.getElementById("itemSearchInput").value.trim().toLowerCase();
  const terms = input.split(',').map(t => t.trim()).filter(t => t);
  const results = {};

  [...monsterData, ...bossData].forEach(mon => {
    if (!mon.drops) return;
    mon.drops.forEach(drop => {
      if (terms.some(term => drop.toLowerCase().includes(term))) {
        if (!results[drop]) results[drop] = [];
        results[drop].push(mon);
      }
    });
  });

  renderItemResults(results);
}

function renderMonsterResults(results) {
  const container = document.getElementById("results");
  container.innerHTML = '';

  if (results.length === 0) {
    container.innerHTML = "<p>검색 결과가 없습니다.</p>";
    return;
  }

  results.forEach(monster => {
    const div = document.createElement('div');
    div.classList.add('result-item');
    const img = getImageElement(monsterImagePath, monster.name, false, sanitizeMonsterName(monster.name));
    div.appendChild(img);
    div.innerHTML += `
      <h3>${monster.name}</h3>
      <p><strong>Level:</strong> ${monster.level || 'N/A'}</p>
      <p><strong>HP:</strong> ${monster.hp || 'N/A'}</p>
      <p><strong>Region:</strong> ${monster.region || 'N/A'}</p>
      <p><strong>EXP:</strong> ${monster.exp || 'N/A'}</p>
      <p><strong>Drops:</strong></p>
    `;

    if (monster.drops && monster.drops.length > 0) {
      monster.drops.forEach(drop => {
        const dropDiv = document.createElement('div');
        dropDiv.classList.add('drop-item');
        const dropImg = getImageElement(itemImagePath, drop, true, sanitizeItemName(drop));
        dropDiv.appendChild(dropImg);
        dropDiv.innerHTML += `<span>${drop}</span>`;
        div.appendChild(dropDiv);
      });
    } else {
      div.innerHTML += `<p><em>None</em></p>`;
    }

    container.appendChild(div);
  });
}

function renderItemResults(results) {
  const container = document.getElementById("results");
  container.innerHTML = '';
  const keys = Object.keys(results);

  if (keys.length === 0) {
    container.innerHTML = "<p>검색 결과가 없습니다.</p>";
    return;
  }

  keys.forEach(item => {
    const div = document.createElement('div');
    div.classList.add('result-item');
    const img = getImageElement(itemImagePath, item, true, sanitizeItemName(item));
    div.appendChild(img);
    div.innerHTML += `<h3>${item}</h3><p><strong>Dropped By:</strong></p><ul>`;
    results[item].forEach(mon => {
      div.innerHTML += `<li>${mon.name} (Level ${mon.level || '?'}, ${mon.region || '?'})</li>`;
    });
    div.innerHTML += `</ul>`;
    container.appendChild(div);
  });
}

loadData();
</script>
</body>
</html>
