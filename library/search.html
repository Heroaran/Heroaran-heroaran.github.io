<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Monster and Item Search</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      color: #222;
      padding: 20px;
      transition: background-color 0.3s, color 0.3s;
    }
    body.dark-mode {
      background-color: #121212;
      color: #eee;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    body.dark-mode .container {
      background: #1e1e1e;
    }
    input[type=text] {
      width: 70%;
      padding: 10px;
      margin-right: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    body.dark-mode input[type=text] {
      background: #333;
      border: 1px solid #555;
      color: #eee;
    }
    button {
      padding: 10px 15px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      background-color: #4CAF50;
      color: white;
      font-weight: bold;
    }
    button:hover {
      background-color: #45a049;
    }
    #darkModeToggle {
      background-color: #2196F3;
      margin-left: 10px;
    }
    #darkModeToggle:hover {
      background-color: #1976D2;
    }
    .back-button {
      background-color: #28a745;
      margin-bottom: 15px;
    }
    .back-button:hover {
      background-color: #218838;
    }
    .result-item {
      border-bottom: 1px solid #ddd;
      padding: 15px 0;
    }
    body.dark-mode .result-item {
      border-color: #444;
    }
    img {
      max-width: 150px;
      margin: 10px 0;
    }
    .drops-list {
      margin-top: 10px;
      padding-left: 15px;
    }
    .drop-item {
      display: flex;
      align-items: center;
      margin-bottom: 5px;
    }
    .drop-item img {
      width: 40px;
      height: auto;
      margin-right: 10px;
    }
    .toggle-drops-btn {
      margin-top: 8px;
      background-color: #555;
    }
    .toggle-drops-btn:hover {
      background-color: #333;
    }
  </style>
</head>
<body>

<div class="container">
  <button class="back-button" id="backButton">Îí§Î°úÍ∞ÄÍ∏∞</button>
  <h1>Î™¨Ïä§ÌÑ∞ Î∞è ÏïÑÏù¥ÌÖú Í≤ÄÏÉâ</h1>

  <div style="margin-bottom: 15px;">
    <input type="text" id="monsterSearchInput" placeholder="Î™¨Ïä§ÌÑ∞ Ïù¥Î¶ÑÏúºÎ°ú Í≤ÄÏÉâ (ÏâºÌëúÎ°ú Ïó¨Îü¨Í∞ú Íµ¨Î∂Ñ Í∞ÄÎä•)">
    <button id="monsterSearchBtn">Í≤ÄÏÉâ</button>
  </div>

  <div style="margin-bottom: 20px;">
    <input type="text" id="itemSearchInput" placeholder="ÏïÑÏù¥ÌÖú Ïù¥Î¶ÑÏúºÎ°ú Í≤ÄÏÉâ (ÏâºÌëúÎ°ú Ïó¨Îü¨Í∞ú Íµ¨Î∂Ñ Í∞ÄÎä•)">
    <button id="itemSearchBtn">Í≤ÄÏÉâ</button>
    <button id="darkModeToggle">üåô Îã§ÌÅ¨ Î™®Îìú</button>
  </div>

  <div id="results"></div>
</div>

<script>
  let monsterData = [], bossData = [];
  const monsterImagePath = "images/monsters/";
  const itemImagePath = "images/items/";

  function getMonsterImage(name) {
    const img = document.createElement('img');
    img.alt = name;
    img.src = monsterImagePath + encodeURIComponent(name) + '.gif';
    img.onerror = () => {
      img.src = monsterImagePath + encodeURIComponent(name) + '.png';
    };
    return img;
  }

  function getItemImage(name) {
    const img = document.createElement('img');
    img.alt = name;
    const normalized = name
      .replace(/\s*\([^\)]*\)/g, '')
      .replace(/[^\w]/g, '_')
      .replace(/_+/g, '_')
      .replace(/^_+|_+$/g, '');
    const base = normalized;
    const attempts = [base + '.png', base + '.gif'];
    let index = 0;
    img.src = itemImagePath + attempts[index];
    img.onerror = () => {
      index++;
      if (index < attempts.length) img.src = itemImagePath + attempts[index];
    };
    return img;
  }

  async function loadData() {
    try {
      const [monsterResp, bossResp] = await Promise.all([
        fetch('data/monster/monster_data.json'),
        fetch('data/monster/boss_data.json')
      ]);
      monsterData = await monsterResp.json();
      bossData = await bossResp.json();
    } catch (e) {
      document.getElementById('results').innerText = "Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®: " + e;
    }
  }

  function searchMonsters() {
    const terms = document.getElementById('monsterSearchInput').value.toLowerCase().split(',').map(t => t.trim()).filter(Boolean);
    if (!terms.length) return alert("Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");
    const results = [...monsterData, ...bossData].filter(m => terms.some(term => m.name.toLowerCase().includes(term)));
    renderMonsters(results);
  }

  function searchItems() {
    const terms = document.getElementById('itemSearchInput').value.toLowerCase().split(',').map(t => t.trim()).filter(Boolean);
    if (!terms.length) return alert("Í≤ÄÏÉâÏñ¥Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.");
    const resultMap = {};
    [...monsterData, ...bossData].forEach(m => {
      m.drops?.forEach(drop => {
        if (terms.some(term => drop.toLowerCase().includes(term))) {
          if (!resultMap[drop]) resultMap[drop] = [];
          resultMap[drop].push(m);
        }
      });
    });
    renderItems(resultMap);
  }

  function renderMonsters(monsters) {
    const c = document.getElementById('results');
    c.innerHTML = monsters.length ? '' : '<p>Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>';
    monsters.forEach(m => {
      const d = document.createElement('div');
      d.className = 'result-item';
      d.innerHTML = `
        <h3>${escapeHtml(m.name)}</h3>
        <p><strong>Level:</strong> ${m.level || 'N/A'}</p>
        <p><strong>HP:</strong> ${m.hp || 'N/A'}</p>
        <p><strong>Region:</strong> ${m.region || 'N/A'}</p>
        <p><strong>EXP:</strong> ${m.exp || 'N/A'}</p>
        ${renderDropList(m.drops, m.name)}
      `;
      d.insertBefore(getMonsterImage(m.name), d.children[1]);
      c.appendChild(d);
      attachDropToggle(m.name);
    });
  }

  function renderItems(results) {
    const c = document.getElementById('results');
    c.innerHTML = Object.keys(results).length ? '' : '<p>Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>';
    for (const [item, monsters] of Object.entries(results)) {
      const d = document.createElement('div');
      d.className = 'result-item';
      d.innerHTML = `
        <h3>ÏïÑÏù¥ÌÖú: ${escapeHtml(item)}</h3>
        <p><strong>Dropped By:</strong></p>
        <ul>${monsters.map(m => `<li>${escapeHtml(m.name)} (Level: ${m.level || 'N/A'}, Region: ${m.region || 'N/A'})</li>`).join('')}</ul>
      `;
      d.insertBefore(getItemImage(item), d.children[1]);
      c.appendChild(d);
    }
  }

  function renderDropList(drops, monsterName) {
    if (!drops?.length) return '';
    const id = monsterName.replace(/[^a-z0-9]/gi, '_');
    return `
      <p><strong>Drops:</strong></p>
      <button class="toggle-drops-btn" data-toggle-id="${id}">Show Drops</button>
      <div class="drops-list" data-toggle-id="${id}" style="display:none;">
        ${drops.map(drop => `<div class="drop-item"><span>${escapeHtml(drop)}</span></div>`).join('')}
      </div>
    `;
  }

  function attachDropToggle(monsterName) {
    const id = monsterName.replace(/[^a-z0-9]/gi, '_');
    const btn = document.querySelector(`.toggle-drops-btn[data-toggle-id="${id}"]`);
    const div = document.querySelector(`.drops-list[data-toggle-id="${id}"]`);
    if (!btn || !div) return;
    btn.addEventListener('click', () => {
      const show = div.style.display !== 'block';
      div.style.display = show ? 'block' : 'none';
      btn.textContent = show ? 'Hide Drops' : 'Show Drops';
      if (!div.querySelector('img')) {
        div.querySelectorAll('.drop-item').forEach(d => {
          const name = d.innerText.trim();
          d.prepend(getItemImage(name));
        });
      }
    });
  }

  function escapeHtml(text) {
    return text?.replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[c]) || '';
  }

  function toggleDarkMode() {
    const body = document.body;
    const btn = document.getElementById('darkModeToggle');
    const isDark = body.classList.toggle('dark-mode');
    btn.textContent = isDark ? '‚òÄÔ∏è ÎùºÏù¥Ìä∏ Î™®Îìú' : 'üåô Îã§ÌÅ¨ Î™®Îìú';
    localStorage.setItem('darkMode', isDark);
  }

  document.getElementById('backButton').onclick = () => history.back();
  document.getElementById('monsterSearchBtn').onclick = searchMonsters;
  document.getElementById('itemSearchBtn').onclick = searchItems;
  document.getElementById('darkModeToggle').onclick = toggleDarkMode;
  if (localStorage.getItem('darkMode') === 'true') toggleDarkMode();
  loadData();
</script>
</body>
</html>
